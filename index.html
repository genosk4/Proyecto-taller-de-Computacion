<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoMind | Monitor Invernadero</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

    <style>
        body { background-color: #f4f6f9; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; }
        .sensor-value { font-size: 2.5rem; font-weight: bold; color: #2c3e50; }
        .unit { font-size: 1rem; color: #7f8c8d; }
        .status-dot { height: 15px; width: 15px; background-color: #bbb; border-radius: 50%; display: inline-block; }
        .online { background-color: #27ae60; }
    </style>
</head>
<body>

<div class="container py-4">
    <header class="pb-3 mb-4 border-bottom">
        <div class="d-flex align-items-center text-dark text-decoration-none">
            <span class="fs-4 fw-bold">ðŸŒ± EcoMind Dashboard</span>
            <span class="ms-auto badge bg-secondary" id="connectionStatus">Desconectado</span>
        </div>
    </header>

    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card p-3 text-center">
                <h5>Temperatura</h5>
                <div class="sensor-value"><span id="val_temp">--</span> <span class="unit">Â°C</span></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 text-center">
                <h5>Humedad</h5>
                <div class="sensor-value"><span id="val_hum">--</span> <span class="unit">%</span></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 text-center">
                <h5>Luz Ambiental</h5>
                <div class="sensor-value"><span id="val_lux">--</span> <span class="unit">Lux</span></div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card p-3">
                <h5>Historial en Tiempo Real</h5>
                <canvas id="myChart" height="100"></canvas>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-info d-none" id="iaAlert">
                <strong>ðŸ¤– Consejo IA:</strong> <span id="iaMessage">Analizando...</span>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. ConexiÃ³n al WebSocket del servidor
    const socket = io();

    // Variables para la grÃ¡fica
    const ctx = document.getElementById('myChart').getContext('2d');
    const maxDataPoints = 20; // Mostrar solo los Ãºltimos 20 puntos
    
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Temperatura (Â°C)',
                borderColor: '#e74c3c',
                data: [],
                fill: false
            }, {
                label: 'Humedad (%)',
                borderColor: '#3498db',
                data: [],
                fill: false
            }]
        },
        options: {
            responsive: true,
            animation: { duration: 0 } // Desactivar animaciÃ³n para fluidez real-time
        }
    });

    // 2. Eventos de ConexiÃ³n
    socket.on('connect', () => {
        document.getElementById('connectionStatus').textContent = "Conectado ðŸŸ¢";
        document.getElementById('connectionStatus').className = "badge bg-success ms-auto";
        console.log("Conectado al servidor WebSocket");
    });

    socket.on('disconnect', () => {
        document.getElementById('connectionStatus').textContent = "Desconectado ðŸ”´";
        document.getElementById('connectionStatus').className = "badge bg-danger ms-auto";
    });

    // 3. RECIBIR DATOS EN TIEMPO REAL
    // Escuchamos el evento 'nuevo_dato_sensor' que emite app.py
    socket.on('nuevo_dato_sensor', (data) => {
        console.log("Dato recibido:", data);

        // A. Actualizar tarjetas numÃ©ricas
        if (data.t) document.getElementById('val_temp').innerText = data.t;
        if (data.h) document.getElementById('val_hum').innerText = data.h;
        if (data.l) document.getElementById('val_lux').innerText = data.l;

        // B. Actualizar GrÃ¡fica
        const timeLabel = new Date().toLocaleTimeString();
        
        // Agregar dato nuevo
        chart.data.labels.push(timeLabel);
        chart.data.datasets[0].data.push(data.t);
        chart.data.datasets[1].data.push(data.h);

        // Eliminar dato viejo si hay muchos (efecto ventana deslizante)
        if (chart.data.labels.length > maxDataPoints) {
            chart.data.labels.shift();
            chart.data.datasets[0].data.shift();
            chart.data.datasets[1].data.shift();
        }

        chart.update();
    });

    // Cargar historial al inicio (Opcional, llama a tu API)
    fetch('/api/historial')
        .then(response => response.json())
        .then(data => {
            // AquÃ­ podrÃ­as poblar la grÃ¡fica con datos antiguos
            // data.forEach(d => { ... lÃ³gica de push ... });
            // Por simplicidad, empezamos en blanco y llenamos en vivo.
        });

</script>
</body>
</html>